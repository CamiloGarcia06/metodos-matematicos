# Makefile para app PCA (FastAPI) - con mensajes de progreso y sin entrar a logs

DC := docker compose
FILE := docker-compose.yml
SERVICE := pca
PORT := 8000
URL := http://localhost:$(PORT)
IMAGE := pca-app:latest

# Atajos
PY := $(DC) -f $(FILE) run --rm $(SERVICE) python

.PHONY: all build start stop restart rebuild status open shell python ps logs logs-pca

all: start

# ConstrucciÃ³n de imagen
build:
	@echo "ğŸ”§ Construyendo imagen Docker..."; \
	$(DC) -f $(FILE) build; \
	echo "âœ… Imagen construida."

# Levantar en background (no adjunta logs). Construye sÃ³lo si no existe la imagen
start:
	@echo "ğŸ” Verificando imagen $(IMAGE)..."; \
	if ! docker image inspect $(IMAGE) >/dev/null 2>&1; then \
	  echo "ğŸ”§ Imagen no encontrada, construyendo..."; \
	  $(DC) -f $(FILE) build; \
	else \
	  echo "âœ… Imagen existente: $(IMAGE)"; \
	fi; \
	echo "ğŸš€ Iniciando servicio en segundo plano..."; \
	$(DC) -f $(FILE) up -d --remove-orphans; \
	echo "â³ Verificando disponibilidad en $(URL)..."; \
	i=0; \
	until curl -sSf -o /dev/null $(URL)/ || [ $$i -ge 30 ]; do \
	  i=$$((i+1)); printf "."; sleep 1; \
	done; echo ""; \
	if [ $$i -ge 30 ]; then \
	  echo "âŒ El servicio no respondiÃ³ a tiempo en $(URL). Revisa 'make status'"; exit 1; \
	else \
	  echo "âœ… Servicio disponible en $(URL)"; \
	fi

# Detener y eliminar (sin logs interactivos)
stop:
	@echo "ğŸ›‘ Deteniendo y limpiando contenedores/redes/volÃºmenes..."; \
	$(DC) -f $(FILE) down --remove-orphans --volumes; \
	echo "âœ… Servicios detenidos."

# Reiniciar sin reconstruir
restart:
	@echo "ğŸ” Reiniciando servicio..."; \
	$(DC) -f $(FILE) down --remove-orphans || true; \
	$(DC) -f $(FILE) up -d --remove-orphans; \
	echo "â³ Verificando disponibilidad en $(URL)..."; \
	i=0; \
	until curl -sSf -o /dev/null $(URL)/ || [ $$i -ge 30 ]; do \
	  i=$$((i+1)); printf "."; sleep 1; \
	done; echo ""; \
	if [ $$i -ge 30 ]; then \
	  echo "âŒ El servicio no respondiÃ³ a tiempo en $(URL)."; exit 1; \
	else \
	  echo "âœ… Servicio disponible en $(URL)"; \
	fi

# Reconstruir desde cero y levantar
rebuild:
	@echo "ğŸ§¹ Eliminando contenedores/volÃºmenes y reconstruyendo sin cachÃ©..."; \
	$(DC) -f $(FILE) down --remove-orphans --volumes || true; \
	$(DC) -f $(FILE) build --no-cache; \
	$(MAKE) start

# Estado rÃ¡pido (contenedor + HTTP)
status:
	@echo "ğŸ“¦ Estado de contenedores:"; \
	$(DC) -f $(FILE) ps | cat; \
	echo "\nğŸŒ Comprobando endpoint raÃ­z:"; \
	if curl -sS -D - $(URL)/ -o /dev/null | head -n 1; then :; else echo "âŒ No hay respuesta"; fi

# Abrir navegador (Linux/Mac)
open:
	@echo "ğŸŒ Abriendo $(URL) en el navegador..."; \
	(if command -v xdg-open >/dev/null 2>&1; then xdg-open $(URL); \
	elif command -v open >/dev/null 2>&1; then open $(URL); \
	else echo "â„¹ï¸  Abre manualmente: $(URL)"; fi) >/dev/null 2>&1 || true

# Shell dentro del contenedor
shell:
	@echo "ğŸš Abriendo shell en el contenedor $(SERVICE)..."; \
	$(DC) -f $(FILE) run --rm $(SERVICE) bash

# REPL de Python en contenedor
python:
	@echo "ğŸ Abriendo REPL de Python en el contenedor $(SERVICE)..."; \
	$(PY)

# Ver logs (opcional, no se usa por defecto)
logs:
	@echo "ğŸ“œ Mostrando logs de todos los servicios (Ctrl+C para salir)..."; \
	$(DC) -f $(FILE) logs -f | cat

logs-pca:
	@echo "ğŸ“œ Mostrando logs de $(SERVICE) (Ctrl+C para salir)..."; \
	$(DC) -f $(FILE) logs -f $(SERVICE) | cat

# Alias
ps: status